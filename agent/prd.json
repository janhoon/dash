[
  {
    "category": "Auth - Core Authentication System",
    "description": "JWT (RS256) authentication with Argon2id password hashing. User registration, login, and profile endpoints.",
    "requirements": {
      "jwt_signing": "RS256 asymmetric keys (4096-bit)",
      "password_hashing": "Argon2id (time=3, memory=64MB, parallelism=4)",
      "endpoints": "POST /api/auth/register, POST /api/auth/login, GET /api/auth/me",
      "middleware": "Auth middleware for protected routes"
    },
    "steps": [
      "Add dependencies: github.com/golang-jwt/jwt/v5, golang.org/x/crypto/argon2",
      "Create backend/internal/auth/jwt.go - RSA key generation, GenerateAccessToken, VerifyAccessToken",
      "Create backend/internal/auth/password.go - HashPassword (Argon2id), VerifyPassword",
      "Create backend/internal/auth/middleware.go - Extract JWT from header, verify, attach user to context",
      "Create backend/internal/handlers/auth.go - register, login, me endpoints",
      "POST /api/auth/register: validate email/password, hash password, create user, return JWT",
      "POST /api/auth/login: find user by email, verify password, return JWT (15 min expiry)",
      "GET /api/auth/me: require auth, return user profile + org memberships",
      "JWT payload: sub (user_id), email, name, exp, iat",
      "Store RSA keys in environment variables (JWT_PRIVATE_KEY, JWT_PUBLIC_KEY)",
      "TEST: Register user → password hashed, JWT returned",
      "TEST: Login with correct password → JWT returned",
      "TEST: Login with wrong password → 401",
      "TEST: /api/auth/me with valid token → user profile",
      "TEST: /api/auth/me with expired token → 401"
    ],
    "passes": true
  },
  {
    "category": "Auth - Refresh Token System",
    "description": "Valkey-backed refresh tokens with rotation and logout-all support.",
    "requirements": {
      "valkey": "Docker compose service, connection via VALKEY_URL",
      "tokens": "Access token (15 min), Refresh token (30 days, stored in Valkey)",
      "rotation": "Generate new refresh token on each use",
      "revocation": "Single logout and logout-all devices"
    },
    "steps": [
      "Add dependency: github.com/redis/go-redis/v9",
      "Create backend/internal/valkey/client.go - NewClient(url)",
      "Add Valkey service to docker-compose.yml (valkey/valkey:7, port 6379)",
      "Create backend/internal/auth/refresh_token.go - GenerateRefreshToken, StoreRefreshToken, GetRefreshToken, RevokeRefreshToken, RevokeAllUserTokens",
      "Update POST /api/auth/login to return both access_token and refresh_token",
      "Store refresh token in Valkey: key=refresh_token:{token}, value={user_id, created_at}, TTL=30 days",
      "POST /api/auth/refresh: verify token in Valkey, generate new tokens, delete old, store new",
      "POST /api/auth/logout: delete refresh token from Valkey",
      "POST /api/auth/logout-all: delete all user's refresh tokens (use user_tokens:{user_id} set)",
      "Implement token rotation: old token invalid after refresh",
      "TEST: Login → receive both tokens",
      "TEST: Refresh token → get new tokens, old invalidated",
      "TEST: Logout → token deleted",
      "TEST: Logout-all → all user tokens deleted"
    ],
    "passes": true
  },
  {
    "category": "Auth - Google SSO",
    "description": "OAuth2 integration with Google Workspace for org-level SSO.",
    "requirements": {
      "oauth2": "Authorization Code flow with PKCE",
      "org_config": "Per-org client_id and client_secret in sso_configs table",
      "provisioning": "Auto-create user or link to existing by email"
    },
    "steps": [
      "Add dependency: golang.org/x/oauth2/google",
      "Create backend/internal/handlers/sso_google.go",
      "GET /api/auth/google/login?org={slug} - Start OAuth flow, redirect to Google",
      "GET /api/auth/google/callback - Exchange code for token, get user info (email, name)",
      "Find or create user by email, add to user_auth_methods (provider=google)",
      "Generate access + refresh tokens, return to frontend",
      "POST /api/orgs/{id}/sso/google - Configure Google SSO (admin only)",
      "GET /api/orgs/{id}/sso/google - Get Google SSO config",
      "Frontend: Add 'Sign in with Google' button",
      "TEST: Google OAuth flow → user created/linked",
      "TEST: Existing user → account linked",
      "TEST: Admin configures SSO → saved"
    ],
    "passes": true
  },
  {
    "category": "Auth - Microsoft SSO",
    "description": "OAuth2 integration with Microsoft Entra ID for org-level SSO.",
    "requirements": {
      "oauth2": "Authorization Code flow",
      "org_config": "Per-org tenant_id, client_id, client_secret",
      "endpoints": "https://login.microsoftonline.com/{tenant}/oauth2/v2.0/*"
    },
    "steps": [
      "Add dependency: golang.org/x/oauth2",
      "Create backend/internal/handlers/sso_microsoft.go",
      "GET /api/auth/microsoft/login?org={slug} - Start OAuth flow",
      "GET /api/auth/microsoft/callback - Exchange code, get user from Microsoft Graph",
      "Find or create user by email, add to user_auth_methods (provider=microsoft)",
      "Generate tokens, return to frontend",
      "POST /api/orgs/{id}/sso/microsoft - Configure Microsoft SSO (admin only)",
      "GET /api/orgs/{id}/sso/microsoft - Get config",
      "Frontend: Add 'Sign in with Microsoft' button",
      "TEST: Microsoft OAuth flow works",
      "TEST: User provisioning works"
    ],
    "passes": false
  },
  {
    "category": "Auth - Multi-Auth Linking",
    "description": "Allow users to link password + Google + Microsoft to one account.",
    "requirements": {
      "linking": "Automatic linking when same email",
      "unlinking": "Can unlink methods, must keep at least one",
      "management": "UI to view/manage linked accounts"
    },
    "steps": [
      "Update SSO login flows to check if user exists with same email",
      "If exists with different provider → link instead of creating duplicate",
      "GET /api/auth/me/methods - List user's auth methods",
      "DELETE /api/auth/me/methods/{id} - Unlink (reject if last method)",
      "Frontend: Profile page showing linked accounts",
      "TEST: User with password adds Google → linked",
      "TEST: User with both can login via either",
      "TEST: Attempt to unlink last method → error"
    ],
    "passes": false
  },
  {
    "category": "Organization - Management",
    "description": "Create orgs, invite users, assign roles, org switching UI.",
    "requirements": {
      "crud": "Create, list, update, delete organizations",
      "invitations": "Email invitations with 7-day TTL in Valkey",
      "roles": "Admin can manage members and roles",
      "switching": "Org dropdown in header"
    },
    "steps": [
      "Create backend/internal/handlers/organization.go",
      "POST /api/orgs - Create org (name, slug)",
      "GET /api/orgs - List user's orgs",
      "GET /api/orgs/{id} - Get org details",
      "PUT /api/orgs/{id} - Update org (admin only)",
      "DELETE /api/orgs/{id} - Delete org (admin only, cascade delete)",
      "POST /api/orgs/{id}/invitations - Invite user (admin only)",
      "Store invitation token in Valkey: key=invitation:{token}, value={org_id, role, email}, TTL=7 days",
      "POST /api/invitations/{token}/accept - Accept invitation, create membership",
      "GET /api/orgs/{id}/members - List members",
      "PUT /api/orgs/{id}/members/{userId}/role - Change role (admin only)",
      "DELETE /api/orgs/{id}/members/{userId} - Remove member (admin only)",
      "Frontend: Org dropdown in header, org settings page, member management",
      "TEST: Create org → succeeds",
      "TEST: Invite user → invitation sent",
      "TEST: Accept invitation → membership created",
      "TEST: Non-admin tries to invite → 403"
    ],
    "passes": false
  },
  {
    "category": "Visualization - Gauge Chart",
    "description": "Circular gauge chart component with thresholds.",
    "requirements": {
      "chart_type": "ECharts gauge",
      "config": "Min/max values, thresholds, unit formatting",
      "prometheus": "Support PromQL queries"
    },
    "steps": [
      "Create frontend/src/components/GaugeChart.vue",
      "Use ECharts gauge type",
      "Props: data, min, max, thresholds, unit, decimals",
      "Implement threshold coloring: [{value: 50, color: 'yellow'}, {value: 80, color: 'red'}]",
      "Unit formatting: %, bytes, seconds, etc.",
      "Integrate into Panel.vue (chart type: 'gauge')",
      "Add to PanelEditModal.vue configuration options",
      "TEST: Query returns 75 → gauge shows 75%",
      "TEST: Threshold at 80 → color changes",
      "TEST: Unit formatting works (1000000 → 1M)"
    ],
    "passes": false
  },
  {
    "category": "Visualization - Pie Chart",
    "description": "Pie/donut chart component with percentages.",
    "requirements": {
      "chart_type": "ECharts pie/donut",
      "features": "Legend, percentages, labels",
      "config": "Pie vs donut mode"
    },
    "steps": [
      "Create frontend/src/components/PieChart.vue",
      "Use ECharts pie type",
      "Props: data, displayAs (pie/donut), showLegend, showLabels",
      "Calculate percentages automatically",
      "Support multiple series",
      "Integrate into Panel.vue (chart type: 'pie')",
      "TEST: Query returns 3 series → 3 slices",
      "TEST: Percentages add up to 100%",
      "TEST: Donut mode shows center hole"
    ],
    "passes": false
  },
  {
    "category": "Visualization - KPI/Stat Panel",
    "description": "Large number display with trend and sparkline.",
    "requirements": {
      "display": "Large number, label, unit formatting",
      "features": "Threshold colors, trend arrow, sparkline",
      "config": "Font size, background color"
    },
    "steps": [
      "Create frontend/src/components/StatPanel.vue",
      "Display single metric value prominently (large font)",
      "Props: data, label, unit, thresholds, showTrend, showSparkline",
      "Background color based on thresholds",
      "Optional trend indicator (compare to previous value)",
      "Optional sparkline (mini line chart) showing history",
      "Integrate into Panel.vue (chart type: 'stat')",
      "TEST: Query returns 1250 → displays '1.25K'",
      "TEST: Threshold exceeded → background changes",
      "TEST: Trend shows up/down arrow"
    ],
    "passes": false
  },
  {
    "category": "Visualization - Universal Chart Features",
    "description": "Shared features for all chart types: thresholds, value mappings, unit formatting.",
    "requirements": {
      "thresholds": "Color changes at specific values",
      "mappings": "Value → text (0 → 'Down', 1 → 'Up')",
      "units": "bytes, seconds, percent, currency, custom",
      "formatting": "Decimal places, null handling"
    },
    "steps": [
      "Create frontend/src/utils/formatting.ts",
      "formatValue(value, unit, decimals) - handle all unit types",
      "applyThresholds(value, thresholds) - return color",
      "applyMappings(value, mappings) - return text or original value",
      "Unit formats: none, short, percent, bytes (B/KB/MB/GB/TB), seconds (s/ms/μs/ns), data rate, temperature, currency",
      "Add to panel configuration schema (thresholds, mappings, unit, decimals)",
      "Apply to all chart components (LineChart, GaugeChart, PieChart, StatPanel)",
      "TEST: Threshold at 80 → color changes when value > 80",
      "TEST: Value 0 mapped to 'Down' → shows 'Down'",
      "TEST: 1048576 bytes → '1 MB'",
      "TEST: 3.14159 with 2 decimals → '3.14'"
    ],
    "passes": false
  }
]
